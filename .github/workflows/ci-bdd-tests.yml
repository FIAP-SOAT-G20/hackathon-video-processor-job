name: ci/bdd-tests

on:
  workflow_run:
    workflows: [ "ci/integration-tests" ]
    types: [ completed ]
    branches: [ main ]
  pull_request:
    types: [ opened, reopened, synchronize ]

permissions:
  contents: read
  pull-requests: write

jobs:
  godog:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Create .env
        run: |
          if [ -f .env.example ]; then cp .env.example .env; fi

      - name: Run BDD tests
        id: bdd-tests
        run: make bdd-test
        continue-on-error: true

      - name: Upload test results and logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bdd-test-results
          path: |
            tests/features/
            tests/*.go
            *.log
          retention-days: 7

      - name: Generate BDD test summary
        if: always()
        id: test-summary
        run: |
          if [ "${{ steps.bdd-tests.outcome }}" = "success" ]; then
            TEST_STATUS="âœ… PASSED"
          else
            TEST_STATUS="âŒ FAILED"
          fi
          cat > bdd_summary.md << 'EOF'
          ## ðŸ§ª BDD Test Results

          ### Feature Files Tested:
          - video_processing.feature

          ---
          EOF
          echo "**Status:** $TEST_STATUS" | cat - bdd_summary.md > bdd_summary2.md && mv bdd_summary2.md bdd_summary.md
          cat bdd_summary.md >> $GITHUB_STEP_SUMMARY
          {
            echo "SUMMARY_CONTENT<<EOF"
            cat bdd_summary.md
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Comment BDD test results on PR
        if: always() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-tag: bdd-test-results
          message: ${{ steps.test-summary.outputs.SUMMARY_CONTENT }}

